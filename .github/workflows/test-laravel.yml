name: ğŸ§ª Test Laravel in Docker

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  laravel-test:
    name: Run Laravel tests in Docker
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Docker Buildx (for building container images)
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 3: Build Docker image from Dockerfile
      - name: ğŸ”¨ Build Laravel Docker image
        run: |
          docker build -t laravel-test -f docker/Dockerfile .

      # Step 4: Run container and verify Laravel bootstraps
      - name: ğŸš€ Run Laravel container
        run: |
          docker run --rm laravel-test php artisan --version
          docker run --rm laravel-test php artisan migrate --pretend

      # Step 5: Run tests (if PHPUnit or Pest is configured)
      - name: ğŸ§ª Run PHPUnit tests
        run: |
          docker run --rm laravel-test vendor/bin/phpunit --testdox || echo "âš ï¸ No PHPUnit tests found"

      # Optional: Clean up Docker cache
      - name: ğŸ§¹ Cleanup Docker
        run: docker system prune -af
